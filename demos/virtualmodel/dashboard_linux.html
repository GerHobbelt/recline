---
layout: moviri
title: Dashboard
recline-deps: true
root: ../../
---

<div id="loadingImage" style="display:none">
	<div style="position:absolute;top:45%;left:45%;width:150px;height:80px;border:1px solid grey;background-color: #E0E0E0;color: black;z-index:100">
		<p class="centered">
			Loading...
			<br>
			<img  src="../../images/ajax-loader.gif" >
		</p>
	</div>
</div>
<div id="container" class="container-fluid">
    <div class="row-fluid">
        <div class="span2 ">
            <div class="row-fluid">
                <div id="search_container"></div>
            </div>
            <div class="row-fluid">
                <div id="search_container1"></div>
            </div>
            <div class="row-fluid">
                <div id="search_container4"></div>
            </div>
            <div class="row-fluid">
                <div id="search_container3"></div>
            </div>
            <div class="row-fluid">
                <div id="search_container2"></div>
            </div>
        </div>
        <div class="span9">
            <div class="row-fluid" style="height:10%">
                <div class="span6">
					<div id="indicator1"></div>
                </div>
                <div class="span6">
					<div id="indicator2"></div>
                </div>
            </div>
            <div class="row-fluid" style="height:30%">
                <div class="span12" >
                    <div id="mygrid"style="overflow:auto" class="dashboard-elem"></div>
                </div>
            </div>
            <!--div class="row-fluid" style="height:20%">
                <div class="span12" >
                    <div id="mygrid2"style="overflow:auto"></div>
                </div>
            </div-->
            <div class="row-fluid" style="height:30%" >
                <div class="span12"><div id="mygraph2" class="dashboard-elem"></div></div>
            </div>
            <div class="row-fluid" style="height:30%">
                <div class="span6" ><div id="mygraph3" class="dashboard-elem"></div></div>
                <div class="span6" ><div id="mygraph4" class="dashboard-elem"></div></div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function() {
        var url = "http://192.168.100.133:8380/cwwh-iwal-war/cw/wh/ds/AudDemoByGender";

        colorSchema = new recline.Data.ColorSchema({   
            type: "scaleWithDistinctData",   
            colors:/* ["#FF0", "#F0F"]*/ ['#00CED1', '#1E90FF'], //["DarkTurquoise", "DodgerBlue"]   
        	data:  ["Female", "Male"]
        });
        
        dataset = new recline.Model.Dataset({
            url: url,
            backend: 'jsonp',
            id: "AudDemoByGender",
            fieldLabels: [{id: "age", label: "Age (bin)"}, {id: "gender", label: "Gender"}],
            inMemoryQueryFields: ["age", "gender"],
            colorSchema: [
                {schema: colorSchema, field: "gender"}
            ]

            //colorSchema: colorSchema
        });
        
        //colorSchema.setDataset(dataset, "gender");
        
   		dataset.bind('query:start', function() { document.getElementById("loadingImage").style.display = "block"; });

           virtualdatasetAge = new recline.Model.VirtualDataset({
                dataset: dataset,
                aggregation: {
                    dimensions: ["age"],
                    aggregatedFields: ["totalviewed", "price_sum"],
                    partitions: ["gender"],
                    aggregationFunctions: ["sum", "avg"]
                },
                colorSchema: colorSchema
            });

        virtualdatasetAge.queryState.addFacetNoEvent("age");

   		virtualdatasetWeekday= new recline.Model.VirtualDataset({
                dataset: dataset,
                aggregation: {
                    dimensions: ["dayofweek"],
                    aggregatedFields: ["totalviewed"],
                    partitions: ["gender"],
                    aggregationFunctions: ["sum", "avg"]
                }//,
                //colorSchema: colorSchema
            });
            virtualdatasetHour= new recline.Model.VirtualDataset({
                dataset: dataset,
                aggregation: {
                    dimensions: ["dayhour"],
                    aggregatedFields: ["totalviewed"],
                    partitions: ["gender"],
                    aggregationFunctions: ["sum", "avg"]
                }//,
                //colorSchema: colorSchema
            });
            virtualdatasetTotal= new recline.Model.VirtualDataset({
				dataset: dataset,
				aggregation: {
				aggregatedFields: ["totalviewed", "price_sum"],
				aggregationFunctions: ["sum"]
				}//,
	            //colorSchema: colorSchema
            });

            virtualdatasetDay= new recline.Model.VirtualDataset({
                dataset: dataset,
                aggregation: {
                    dimensions: ["daydate"],
                    aggregatedFields: ["totalviewed", "price_sum"],
                    partitions: ["gender"],
                    aggregationFunctions: ["sum", "avg"]
                }//,
                //colorSchema: colorSchema
            });
            virtualdatasetDay.queryState.attributes.sort = [{field:"daydate"}];

            virtualdatasetDay.bind('query:done query:fail', function() { document.getElementById("loadingImage").style.display = "none";resizeAllElems(); });
			
		var action_db = new recline.Action({
            filters: {
                filter_daydate: {type: "range", field: "daydate", fieldType: "date"}
            },
            models: [
                {model: dataset, filters:["filter_daydate"]}
            ],
            type: ["filter", "selection"]
        });
		
		var action_db2 = new recline.Action({
            filters: {
                filter_gender: {type: "list", field: "gender", fieldType: "string"}
            },
            models: [
                {model: dataset, filters:["filter_gender"]}
            ],
            type: ["filter"]
        });
		
		var action_vmodel = new recline.Action({
            filters: {
                filter_age:     {type: "list",  field: "age", fieldType: "number"}
            },
            models: [
                {model: virtualdatasetAge, filters:["filter_age"]},
				{model: dataset, filters:["filter_age"]}
            ],
            type: ["selection"]
        });

		var dateFilter = {field: "daydate", type: "range", start:new Date(2012,0,01,00,00,00,0), stop:new Date(2012,0,30,00,00,00,0), fieldType: "date" };
        dataset.queryState.addFilter(dateFilter);
        dataset.queryState.addSelection(dateFilter);
        
    	dataset.queryState.addFacetNoEvent("gender");

   		dataset.fetch(); // needed to populate filter list
		
   		
           var $el = $('#mygrid');
		   var grid = new recline.View.SlickGrid(
											{model: virtualdatasetAge, el: $el, 
												state: {
													fitColumns:true, 
													visibleColumns: ['totalviewed_sum', 'price_sum_sum', 'age', 'inner_chart'],
													columnsOrder: ['age', 'totalviewed_sum', 'price_sum_sum', 'innerChart'],
													useInnerChart:true, 
													innerChartSerie1:'totalviewed_by_gender_Male_sum', 
													innerChartSerie2:'totalviewed_by_gender_Female_sum', 
													innerChartHeader:'Views by Gender',
													fieldLabels: [{id: "totalviewed_sum", label: "Views"}, {id: "price_sum_sum", label: "Revenues"}]
												},
												actions : [{
													action : action_vmodel,
													mapping : [{
														srcField : "age",
														filter : "filter_age"
													}],
													event : ["onSelectedRangesChanged"]
												}]
											}); 
            grid.visible = true;
            grid.render();

		   // $el = $('#mygrid2');
		   // var grid2 = new recline.View.SlickGrid(
											// {model: dataset, el: $el, 
												// state: {
													// fitColumns:true, 
												// }
											// }); 
            // grid2.visible = true;
            // grid2.render();

            var graph2 = new recline.View.NVD3Graph({
                model: virtualdatasetDay,
                state: {
                    group: "daydate",
					yLabel: "Total Viewed",
                    seriesValues: ["totalviewed_by_gender_Male_sum", "totalviewed_by_gender_Female_sum"],
                    graphType: "lineChart",
                    id: "2",
					fieldLabels: [{id: "totalviewed_by_gender_Male_sum", label: "Male"}, {id: "totalviewed_by_gender_Female_sum", label: "Female"}]
                },
				actions: [{
					action: action_db,
					mapping: [
						{srcField: "daydate", filter: "filter_daydate"}
					],
					event: ["elementSelection"]
				}]
            });
            $('#mygraph2').append(graph2.el);

            var graph3 = new recline.View.NVD3Graph({
                model: virtualdatasetWeekday,
                useFilteredData: false,
                state: {
                    group: "dayofweek",
					yLabel: "Total Viewed AVG",
                    //seriesNameField: ["gender"],
                    seriesValues: ["totalviewed_by_gender_Male_avg", "totalviewed_by_gender_Female_avg"],
					//colors: [colorSchema.getColorFor("Male"), colorSchema.getColorFor("Female")],
                    graphType: "multiBarChart",
                    id: "3",
   					fieldLabels: [{id: "totalviewed_by_gender_Male_sum", label: "Male"}, {id: "totalviewed_by_gender_Female_sum", label: "Female"}]
                }
            });
            $('#mygraph3').append(graph3.el);




            var graph4 = new recline.View.NVD3Graph({
                model: virtualdatasetHour,
                state: {
                    group: "dayhour",
					yLabel: "Total Viewed AVG",
                    //seriesNameField: ["gender"],
                    seriesValues: ["totalviewed_by_gender_Male_avg", "totalviewed_by_gender_Female_avg"],
					//colors: [colorSchema.getColorFor("Male"), colorSchema.getColorFor("Female")],
                    graphType: "multiBarChart",
                    id: "4",
   					fieldLabels: [{id: "totalviewed_by_gender_Male_sum", label: "Male"}, {id: "totalviewed_by_gender_Female_sum", label: "Female"}]
                }
            })
            $('#mygraph4').append(graph4.el);


            var indicator1 = new recline.View.Indicator({
                model: virtualdatasetTotal,
                state: {
                    series: ["totalviewed_sum"],
                    format: ',d',
					label:"Views",
                    id: "6"
                }
            });
            $('#indicator1').append(indicator1.el);
            indicator1.render();


            var indicator2 = new recline.View.Indicator({
                model: virtualdatasetTotal,
                state: {
                    series: ["price_sum_sum"],
                    format: ',.02f',
					label:"Revenues",
                    id: "7"
                }
            });
            $('#indicator2').append(indicator2.el);
            indicator2.render();

			var filter = new recline.View.GenericFilter({
                sourceDataset: dataset,
				sourceFields: [{field: "daydate", controlType: 'range_calendar', type: "range", fieldType: "date" }],
                actions: [{
                    action: action_db,
                    mapping: [
                        {srcField: "daydate", filter: "filter_daydate"}
                    ],
                    event: ["onFilterValueChanged", "onListItemClicked", "onRemoveFilter"]
                }]
            });
            $('#search_container').append(filter.el);

            var filter1 = new recline.View.GenericFilter({
                sourceDataset: dataset,
				sourceFields: [{field: 'daydate', type: "range", controlType: 'month_week_calendar', fieldType: 'date'}	],
                actions: [{
                    action: action_db,
                    mapping: [
                        {srcField: "daydate", filter: "filter_daydate"}
                    ],
                    event: ["onFilterValueChanged", "onListItemClicked", "onRemoveFilter"]
                }]
            });
            $('#search_container1').append(filter1.el);

            var filter2 = new recline.View.GenericFilter({
                sourceDataset: virtualdatasetAge,
				sourceFields: [
								{field: 'age', controlType: 'list', fieldType: 'number'}//,
								//{field: 'age', controlType: 'range_slider', fieldType: 'number'}
							],
                actions: [{
                    action: action_vmodel,
                    mapping: [
                        {srcField: "age", filter: "filter_age"}
                    ],
                    event: ["onFilterValueChanged", "onListItemClicked", "onRemoveFilter"]
                }]
            });
            $('#search_container2').append(filter2.el);

            var filter3 = new recline.View.GenericFilter({
                sourceDataset: dataset,
				sourceFields: [
								{field: 'gender', controlType: 'legend', fieldType: 'list'}
							],
                actions: [{
                    action: action_db2,
                    mapping: [
                        {srcField: "gender", filter: "filter_gender"}
                    ],
                    event: ["onLegendItemClicked"]
                }]
            });
            $('#search_container3').append(filter3.el);

            var filter4 = new recline.View.GenericFilter({
                sourceDataset: virtualdatasetAge,
				sourceFields: [
								{field: 'age', controlType: 'color_legend', fieldType: 'term'}
							],
                actions: [{
                    action: action_vmodel,
                    mapping: [
                        {srcField: "age", filter: "filter_age"}
                    ],
                    event: ["onFilterValueChanged", "onListItemClicked", "onRemoveFilter"]
                }]
            });
            $('#search_container4').append(filter4.el);

            // var facet = new recline.View.FacetViewer({
				// model: virtualdatasetAge
			// });
            // $('#facet_container').append(facet.el);
			
			
        resizeAllElems(); // force initial resize
		
		$(window).resize(resizeAllElems);
		
		function resizeAllElems() {
			//console.log("resize all elems")
			_.each([{el:"mygrid", obj:grid}, {el:"mygraph2", obj:graph2}, {el:"mygraph3", obj:graph3}, {el:"mygraph4", obj:graph4}], function(eo) { 
						resizeElem(eo.el, eo.obj);	
						//$(this).trigger('element-resize');
					});
		}
		
		function resizeElem(elemName, obj)
		{
			var availH = window.innerHeight-5; // substract 5px for Chrome
			var perc = document.getElementById(elemName).parentNode.parentNode.style.height.replace("%", "")/100;
			var newH = parseInt(availH * perc);
			$("#"+elemName).height(newH);
			$("#"+elemName+" svg").height(newH);
			obj.height = newH;
			obj.update
		}

	});


</script>